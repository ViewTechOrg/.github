name: Update Org Stats

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Requests
        run: pip install requests

      - name: Generate Org Stats
        run: |
          python <<EOF
          import requests

          ORG = "ViewTechOrg"
          headers = {"Accept": "application/vnd.github+json"}

          repos = requests.get(f"https://api.github.com/orgs/{ORG}/repos?per_page=100").json()
          stars = sum(r.get("stargazers_count", 0) for r in repos)
          forks = sum(r.get("forks_count", 0) for r in repos)
          total_repos = len(repos)

          members = requests.get(f"https://api.github.com/orgs/{ORG}/members").json()
          total_members = len(members)

          md = f'''<!--ORG_STATS_START-->
📊 **Statistik ViewTechOrg (Live)**

- 🔧 Total Repos: `{total_repos}`
- ⭐ Total Stars: `{stars}`
- 🍴 Total Forks: `{forks}`
- 👥 Anggota Terdaftar: `{total_members}`
- 📦 Bahasa Dominan: `Shell`, `Python`
<!--ORG_STATS_END-->'''

          with open("org_stats.md", "w") as f:
              f.write(md)
          EOF

      - name: Inject into README
        run: |
          sed -i '/<!--ORG_STATS_START-->/, /<!--ORG_STATS_END-->/{
            r org_stats.md
            d
          }' .github/profile/README.md

      - name: Commit and Push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .github/profile/README.md
          git commit -m "update: org stats"
          git push
