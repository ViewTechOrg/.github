name: Update Org Stats

on:
  schedule:
    - cron: "0 */6 * * *"  # setiap 6 jam
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Requests
        run: pip install requests

      - name: Generate Org Stats
        run: |
          python <<EOF
          import requests

          ORG = "ViewTechOrg"
          headers = {"Accept": "application/vnd.github+json"}

          # Get org repos
          repos = requests.get(f"https://api.github.com/orgs/{ORG}/repos?per_page=100", headers=headers).json()
          stars = sum(repo["stargazers_count"] for repo in repos)
          forks = sum(repo["forks_count"] for repo in repos)
          total_repos = len(repos)

          # Get members
          members = requests.get(f"https://api.github.com/orgs/{ORG}/members", headers=headers).json()
          total_members = len(members)

          stats_md = f"""\
ðŸ“Š **Statistik ViewTechOrg (Live)**

- ðŸ”§ Total Repos: `{total_repos}`
- â­ Total Stars: `{stars}`
- ðŸ´ Total Forks: `{forks}`
- ðŸ‘¥ Anggota Terdaftar: `{total_members}`
- ðŸ“¦ Bahasa Dominan: `Shell`, `Python`
"""

          with open("org_stats.md", "w") as f:
              f.write("<!--ORG_STATS_START-->\n" + stats_md + "\n<!--ORG_STATS_END-->")
          EOF

      - name: Update README
        run: |
          sed -i '/<!--ORG_STATS_START-->/, /<!--ORG_STATS_END-->/c\$(cat org_stats.md)' README.md

      - name: Commit & Push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md
          git commit -m "update: org stats"
          git push
